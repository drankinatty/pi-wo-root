# ===== Options =====|-------------------------------------------------------------|
# 1. make 		- compile library
# 2. make install 	- install library to filesystem may need sudo)
# 3. make clean 	- deletes .o files generated by step 1 from build directory
# 4. make uninstall  	- uninstalls library (may need sudo)
# ===================|--------------------------------------------------------------|
#

# Where you want it installed
PREFIX 	= /usr/local
# where to place the libray
LIBDIR	= $(PREFIX)/lib
# library name
LIB	= libfusion
# shared library name
LIBNAME	= $(LIB).so.1.0

MD	= mkdir
SRC	= src
OBJ	= obj
SRCS 	= $(wildcard $(SRC)/*.c)
OBJS 	= $(patsubst $(SRC)%.c,  $(OBJ)/%.o, $(SRCS))

CX	= gcc
CFLAGS	= -march=native -mtune=native -mcpu=native
CFLAGS += -Wall -Wextra -pedantic -Wshadow -std=c11
CFLAGS += -Iinclude
CFLAGS += -D_GNU_SOURCE
LDFLAGS	= -lm

# make all
# reinstall the library after each recompilation
all: clean pre-build fusion

pre-build:
	@echo
	@echo "*****************"
	@echo "[MAKE LIBRARY]"
	@echo
	$(MD) -vp $(OBJ)

# Make the library
fusion:	$(OBJS)
	$(CC) -shared -Wl,-soname,$(LIB).so.1 $(CFLAGS) $(LDFLAGS) -o ${LIBNAME} $^

# Library parts
$(OBJ)/%.o: $(SRC)/%.c
	$(CC) -Wall -Wextra -Wshadow -fPIC -c $(CFLAGS) $< -o $@

# Install the library to LIBPATH
install:
	@echo
	@echo "*****************"
	@echo "[INSTALL LIBRARY]"
	@if ( test ! -d $(PREFIX)/lib ) ; then mkdir -vp $(PREFIX)/lib ; fi
	@install -vm 0755 ${LIBNAME} ${LIBDIR}
	@ln -svf ${LIBDIR}/${LIBNAME} ${LIBDIR}/${LIB}.so.1
	@ln -svf ${LIBDIR}/${LIBNAME} ${LIBDIR}/${LIB}.so
	@ldconfig
	@rm -rvf ${LIB}.*
	@echo "*****************"
	@echo
	@echo "[INSTALL LIBRARY HEADERS]"
	@if ( test ! -d $(PREFIX)/include ) ; then mkdir -p $(PREFIX)/include ; fi
	@cp -vf include/Fusion.h $(PREFIX)/include
	@cp -vf include/FusionAhrs.h $(PREFIX)/include
	@cp -vf include/FusionAxes.h $(PREFIX)/include
	@cp -vf include/FusionCalibration.h $(PREFIX)/include
	@cp -vf include/FusionCompass.h $(PREFIX)/include
	@cp -vf include/FusionConvention.h $(PREFIX)/include
	@cp -vf include/FusionMath.h $(PREFIX)/include
	@cp -vf include/FusionOffset.h $(PREFIX)/include
	@echo "[DONE!]"

# Uninstall the library
uninstall:
	@echo "******************"
	@echo "[UNINSTALL LIBRARY]"
	@rm -vf ${LIBDIR}/${LIB}.so*
	@ldconfig

	@echo "[UNINSTALL LIBRARY HEADERS]"
	@rm -vf $(PREFIX)/include/Fusion.h
	@rm -vf $(PREFIX)/include/FusionAhrs.h
	@rm -vf $(PREFIX)/include/FusionAxes.h
	@rm -vf $(PREFIX)/include/FusionCalibration.h
	@rm -vf $(PREFIX)/include/FusionCompass.h
	@rm -vf $(PREFIX)/include/FusionConvention.h
	@rm -vf $(PREFIX)/include/FusionMath.h
	@rm -vf $(PREFIX)/include/FusionOffset.h
	@echo "[DONE!]"

# clear build files
clean:
	@echo "******************"
	@echo "[CLEAN OBJECT FILES]"
	@rm -rvf $(OBJ) ${LIB}.*
	@echo "[DONE!]"
