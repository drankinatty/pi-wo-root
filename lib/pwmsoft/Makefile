# == Options ==
# 1. make = compile library
# 2. make install = install library to filesystem may need sudo)
# 3. make clean = deletes .o files generated by step 1 from build directory
# 4. make uninstall  = uninstalls library (may need sudo)
# =============

# Where you want it installed
PREFIX = /usr/local
# where to place the libray
LIBDIR = $(PREFIX)/lib
# source file name
SRCNAME = pwmsoft
# library name
LIB = libpwmsoft
# soname version
SONAME = $(LIB).so.1
# shared library name
LIBNAME = $(SONAME).0

MD  = mkdir
SRC = src
OBJ = obj
SRCS = $(wildcard $(SRC)/*.c)
OBJS = $(patsubst $(SRC)%.c, $(OBJ)/%.o, $(SRCS))

CC = gcc
CFLAGS = -march=native -mtune=native -mcpu=native -Iinclude/
CFLAGS += -Wall -Wextra -pedantic -Wshadow -std=c11
# CFLAGS += -D_POSIX_C_SOURCE
CFLAGS += -D_GNU_SOURCE
LDFLAGS = -litimer -lrt

# make all
# reinstall the library after each recompilation
all: clean pre-build lib

pre-build:
	@printf -- "\nBuild %s Library\n----------------------------------------\n" "${SRCNAME}"
	$(MD) -vp $(OBJ)

# Make the library
lib: 	$(OBJS)
	$(CC) -shared -Wl,-soname,$(SONAME) $(CFLAGS) $(LDFLAGS) -o ${LIBNAME} $^

# Library parts
$(OBJ)/%.o: $(SRC)/%.c
	$(CC) -Wall -Wextra -Wshadow -fPIC -c $(CFLAGS) $< -o $@

# Install the library to LIBPATH
install:
	@printf -- "\nInstall %s Library\n----------------------------------------\n" "${SRCNAME}"
	@ln -svf ${LIBNAME} ${SONAME}
	@ln -svf ${LIBNAME} ${LIB}.so
	@if ( test ! -d $(PREFIX)/lib ) ; then mkdir -vp $(PREFIX)/lib ; fi
	#@ln -svf ${LIBDIR}/${LIBNAME} ${LIBDIR}/${LIB}.so.1
	#@ln -svf ${LIBDIR}/${LIBNAME} ${LIBDIR}/${LIB}.so
	@install -vm 0755 ${LIBNAME} ${LIBDIR}
	@mv -vf ${SONAME} ${LIBDIR}
	@mv -vf ${LIB}.so ${LIBDIR}

	@printf -- "\nInstall Library Headers\n----------------------------------------\n"
	@if ( test ! -d $(PREFIX)/include ) ; then mkdir -p $(PREFIX)/include ; fi
	@cp -vf  include/$(SRCNAME).h $(PREFIX)/include

	@printf -- "\nldconfig\n----------------------------------------\n"
	ldconfig

# Uninstall the library
uninstall:
	@printf -- "\nUnistall %s Library\n----------------------------------------\n" "${SRCNAME}"
	@rm -vf ${LIBDIR}/${LIB}.*

	@printf -- "\nUninstall Library Headers\n----------------------------------------\n"
	@rm -rvf  $(PREFIX)/include/$(SRCNAME).h

	@printf -- "\nldconfig\n----------------------------------------\n"
	ldconfig

# clear build files
clean:
	@printf -- "\nRemove object files\n----------------------------------------\n"
	#rm -rvf $(OBJ)/*.o ${LIB}.*
	rm -rvf $(OBJ) ${LIB}.*
	@echo "[DONE!]"
